<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Phosphor: One-pager: Tracing in KV-Engine</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Phosphor
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md_docs_design_One-pager.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">One-pager: Tracing in KV-Engine </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><em>Date: 2016-04-19</em></p>
<p><em>Author: Will Gardner</em></p>
<p>The purpose of this document is to discuss general requirements and motivation for an event tracing system in KV-Engine rather than implementation/API details.</p>
<h2>Motivation</h2>
<p>An event tracer in KV-Engine is principally aimed at identifying performance issues that a sampling profiler might not be able to trivially shed light on. Examples include &gt;99% operation latencies (such as those improved by DCP changes in 3.1.4) and the NONIO thread being blocked by a non-yielding task (e.g. the DCP consumer).</p>
<p>A well-tooled event tracer would allow for analysis both on a per-thread basis and also on a request/command basis even across threads (Such as the transition between front-end memcached and back-end ep-engine threads). This kind of analysis would allow for identifying what makes an individual request slow or an individual thread busy.</p>
<h2>What</h2>
<p>An event tracer would maintain a timestamped log of various synchronous events that occur in a single thread such as function calls (both enter and return) and also asynchronous events that may occur across threads such as EWOULDBLOCK handling. The event log would include contextual information such as thread id and process id while asynchronous events would also include further event identification such as the request cookie. In addition events would be taggable with miscellaneous information such as function arguments.</p>
<p>Ideally the event tracer would be continually running and a dump of an in-memory buffer could be performed as required (e.g. when performing a cb_collectinfo). This could be flushed to disk or similar. Alternatively if the overhead of event tracing is high, tracing could be enabled on demand and run for X amount of time or Y amount of space. This could provide valuable insight into what is hurting performance in a live customer environment. Category-based event filtering could allow for differing levels of logging at specific times (e.g. low-level tracing most of the times, but increased for a cb_collectinfo or developer debugging in certain areas).</p>
<p>KV-Engine would be explicitly tooled with event logging in key areas via a simple API.</p>
<h2>Inspiration</h2>
<p>The Chromium Project’s event profiler (<a href="https://www.chromium.org/developers/how-tos/trace-event-profiling-tool">https://www.chromium.org/developers/how-tos/trace-event-profiling-tool</a>) provides a lot of desirable functionality. Chromium’s event profiler is comprised of two parts: C++ code tooling for generating traces, and a trace viewer.</p>
<p>The code tooling is a simple macro-driven API (<a href="https://code.google.com/p/chromium/codesearch#chromium/src/base/trace_event/common/trace_event_common.h">https://code.google.com/p/chromium/codesearch#chromium/src/base/trace_event/common/trace_event_common.h</a>) that stores traces to an in-memory buffer when triggered. The API is minimalistic and where possible uses RAII to prevent repetition (e.g. function entry/return). This buffer can be dumped to a JSON format (<a href="https://docs.google.com/document/d/1CvAClvFfyA5R-PhYUmn5OOQtYMH4h6I0nSsKchNAySU/edit?pli=1">https://docs.google.com/document/d/1CvAClvFfyA5R-PhYUmn5OOQtYMH4h6I0nSsKchNAySU/edit?pli=1</a>) when required.</p>
<p>The event viewer is embedded into Chrome (chrome://tracing/) and reads traces in the aforementioned trace format. The code for the event viewer is stored separately as part of the Catapult project (<a href="https://github.com/catapult-project/catapult/tree/master/tracing">https://github.com/catapult-project/catapult/tree/master/tracing</a>) and could be adapted to work with other browsers with minimal work.</p>
<p>There is also an alternative tracing framework (Also by Google) <a href="http://google.github.io/tracing-framework/">http://google.github.io/tracing-framework/</a> that comes with some simple C++ tooling. The main advantage of this is the improved UI interactions but does not have proper support for asynchronous events. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
